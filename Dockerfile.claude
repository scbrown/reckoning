FROM ubuntu:24.04

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install essential packages
RUN apt update && apt install -y \
    sudo \
    curl \
    git \
    wget \
    vim \
    build-essential \
    ca-certificates \
    gnupg \
    unzip \
    redis-tools \
    ripgrep \
    fd-find \
    fzf \
    byobu \
    luarocks \
    python3 \
    python3-pip \
    python3-venv \
    sqlite3 \
    && rm -rf /var/lib/apt/lists/*

# Install Neovim (LazyVim requires >= 0.11.2)
RUN curl -LO https://github.com/neovim/neovim/releases/download/v0.11.2/nvim-linux-x86_64.tar.gz && \
    tar -C /opt -xzf nvim-linux-x86_64.tar.gz && \
    ln -s /opt/nvim-linux-x86_64/bin/nvim /usr/local/bin/nvim && \
    rm nvim-linux-x86_64.tar.gz

# Install Node.js 20.x (project requires >=18.0.0)
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt install -y nodejs && \
    rm -rf /var/lib/apt/lists/*

# Install pnpm 8.x globally (project requires >=8.0.0)
RUN npm install -g pnpm@8

# Install just (command runner used by project)
RUN curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin

# Install Go (optional, for beads/gastown tools)
RUN curl -fsSL https://go.dev/dl/go1.22.0.linux-amd64.tar.gz | tar -C /usr/local -xzf -
ENV PATH="/usr/local/go/bin:$PATH"

# Install Docker CLI (to interact with host Docker via socket mount)
RUN install -m 0755 -d /etc/apt/keyrings && \
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc && \
    chmod a+r /etc/apt/keyrings/docker.asc && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null && \
    apt update && \
    apt install -y docker-ce-cli docker-compose-plugin && \
    rm -rf /var/lib/apt/lists/*

# Create admin user with passwordless sudo
RUN useradd -m -s /bin/bash admin && \
    echo "admin ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers && \
    mkdir -p /home/admin/.npm-global && \
    mkdir -p /home/admin/go && \
    mkdir -p /home/admin/.config/nvim && \
    mkdir -p /home/admin/.local/share/nvim && \
    chown -R admin:admin /home/admin

# Add admin to docker group (will match host docker group)
RUN groupadd -g 999 docker-host || true && \
    usermod -aG docker-host admin

# Set environment for admin user
USER admin
ENV NPM_CONFIG_PREFIX=/home/admin/.npm-global
ENV GOPATH=/home/admin/go
ENV PATH=/home/admin/.npm-global/bin:/home/admin/go/bin:/usr/local/go/bin:$PATH
ENV EDITOR=nvim
WORKDIR /home/admin

# Install Claude Code globally for admin user
RUN npm install -g @anthropic-ai/claude-code

# Install beads and gastown (optional Go tools)
RUN go install github.com/anthropics/beads/cmd/bd@latest || true
RUN go install github.com/anthropics/gastown/cmd/gt@latest || true

# Install LazyVim starter config
RUN git clone https://github.com/LazyVim/starter /home/admin/.config/nvim && \
    rm -rf /home/admin/.config/nvim/.git

# Add render-markdown plugin and Dracula theme to LazyVim
RUN mkdir -p /home/admin/.config/nvim/lua/plugins && \
    cat > /home/admin/.config/nvim/lua/plugins/custom.lua << 'LUA'
return {
  -- Dracula colorscheme
  {
    "Mofiqul/dracula.nvim",
    lazy = false,
    priority = 1000,
    config = function()
      vim.cmd([[colorscheme dracula]])
    end,
  },
  -- Render markdown in buffer
  {
    "MeanderingProgrammer/render-markdown.nvim",
    dependencies = { "nvim-treesitter/nvim-treesitter", "nvim-tree/nvim-web-devicons" },
    opts = {},
  },
}
LUA

# Disable LazyVim default colorscheme so Dracula takes effect
RUN cat > /home/admin/.config/nvim/lua/plugins/disabled.lua << 'LUA'
return {
  { "catppuccin/nvim", enabled = false },
  { "folke/tokyonight.nvim", enabled = false },
}
LUA

# Pre-install plugins (headless nvim run)
RUN nvim --headless "+Lazy! sync" +qa || true

# Create workspace and ssh directories
RUN mkdir -p /home/admin/workspace /home/admin/.ssh && \
    chmod 700 /home/admin/.ssh && \
    chown -R admin:admin /home/admin/workspace /home/admin/.ssh

# Stage home directory contents for volume initialization (need root)
USER root
RUN cp -a /home/admin /home/admin-initial

# Entrypoint script to initialize volume on first run and fix permissions
RUN cat > /home/admin-initial/entrypoint.sh << 'ENTRYPOINT'
#!/bin/bash
# Initialize home volume if empty (first run)
if [ ! -f /home/admin/.initialized ]; then
  echo "First run: initializing home directory from image..."
  cp -a /home/admin-initial/. /home/admin/
  touch /home/admin/.initialized
  chown -R admin:admin /home/admin
fi
# Fix workspace permissions and git safe directory
chown -R admin:admin /home/admin/workspace 2>/dev/null
gosu admin git config --global --add safe.directory '*'
# Drop to admin user
exec gosu admin "$@"
ENTRYPOINT
RUN chmod +x /home/admin-initial/entrypoint.sh

# Install gosu for dropping privileges in entrypoint
RUN apt-get update && apt-get install -y gosu && rm -rf /var/lib/apt/lists/*

# Start in admin's home directory
WORKDIR /home/admin

ENTRYPOINT ["/home/admin-initial/entrypoint.sh"]
CMD ["/bin/bash"]
